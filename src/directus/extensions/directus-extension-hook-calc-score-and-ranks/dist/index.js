"use strict";console.log("Extension loaded");var e=Object.freeze({__proto__:null,calculateScores:async function({municipalityIds:e=null,catalogVersionId:a},{services:t,getSchema:i,logger:r}){r.info("Recalculating scores for "+(e?.length?e?.length:"all")+" municipalities and catalogVersion: "+a);const s=await i(),n=new t.ItemsService("ratings_measures",{schema:s,accountability:{admin:!0}}),o=new t.ItemsService("measures",{schema:s,accountability:{admin:!0}}),c=new t.ItemsService("municipalities",{schema:s,accountability:{admin:!0}}),l=new t.ItemsService("municipality_scores",{schema:s,accountability:{admin:!0}});try{const t=await o.readByQuery({limit:-1,filter:{catalog_version:{_eq:a},status:{_eq:"published"}},fields:["id","sector","weight"]});if(!t?.length)return void r.info(`[calculateScores] No published measures for catalog ${a}.`);const i=new Map(t.map(e=>[e.id,e])),s=await c.readByQuery({limit:-1,...e?.length?{filter:{id:{_in:e}}}:{},fields:["id","localteam_id","name"]});if(!s?.length)return void r.info("[calculateScores] No municipalities to process.");r.info(`[calculateScores] Processing ${s.length} municipalities for catalog ${a}.`);for(const e of s){const s=e.localteam_id;if(!s)continue;const o=await n.readByQuery({limit:-1,filter:{localteam_id:{_eq:s},applicable:{_eq:!0},approved:{_eq:!0},measure_published:{_eq:!0},measure_id:{catalog_version:{_eq:a},status:{_eq:"published"}}},fields:["rating","measure_id"]});if(!o?.length){r.info(`[calculateScores] No candidate ratings for municipality "${e.name}".`);continue}const c={numerator_rated_sum:0,denominator_rated:0,denominator_all:0},u={};for(const e of t)u[e.sector]||(u[e.sector]={numerator_rated:0,denominator_rated:0});let m=0;for(const e of o){const a="object"==typeof e.measure_id?e.measure_id.id:e.measure_id,t=i.get(a);if(!t)continue;const r=t.weight??0;if(r<=0)continue;const s=t.sector??"total";c.denominator_all+=r;const n=e.rating,o=null!=n?parseFloat(n):NaN;Number.isNaN(o)||(c.numerator_rated_sum+=o*r,c.denominator_rated+=r,m+=r,u[s]||(u[s]={numerator_rated:0,denominator_rated:0}),u[s].numerator_rated+=o*r,u[s].denominator_rated+=r)}const d={};d.percentage_rated=c.denominator_all>0?m/c.denominator_all*100:0,c.denominator_rated>0?d.score_total=c.numerator_rated_sum/c.denominator_rated*100:d.score_total=0;for(const[e,a]of Object.entries(u)){const t=a.denominator_rated>0?a.numerator_rated/a.denominator_rated*100:0;d[`score_${e}`]=t}const[g]=await l.readByQuery({limit:1,filter:{municipality:{_eq:e.id},catalog_version:{_eq:a}},fields:["id"]});g?.id?(await l.updateOne(g.id,d),r.info(`[calculateScores] Completed scoring and updated municipality_scores for "${e.name}" (${g.id}).`)):r.warn(`[calculateScores] Completed scoring, but no municipality_scores record found for "${e.name}" and thus could not update scores!`)}r.info(`[calculateScores] Completed calculations for catalog ${a}.`)}catch(e){throw r.error(e),e}}});module.exports=({action:a,filter:t},{services:i,database:r,getSchema:s,logger:n})=>{const o={admin:!0},c=async(a,t)=>{const{calculateScores:i}=await Promise.resolve().then(function(){return e});return await i(a,t)},l=async({catalogVersionId:e},{services:a,getSchema:t,logger:i})=>{i.info(`Updating ranks for catalogVersionId=${e}`);const r=await t(),s=new a.ItemsService("municipality_scores",{schema:r,accountability:{admin:!0}}),n=await s.readByQuery({limit:-1,filter:{catalog_version:{_eq:e},municipality:{status:{_eq:"published"}},percentage_rated:{_gt:95}},fields:["id","score_total"]});if(!n?.length)return i.info(`[updateRanks] No published scores with percentage_rated > 95 found for catalogVersion=${e}, thus not recalculating scores`);const o=n.sort((e,a)=>(a.score_total??0)-(e.score_total??0)).map((e,a,t)=>({id:e.id,rank:0===a||e.score_total!==t[a-1].score_total?a+1:t[a-1].rank}));for(const e of o)await s.updateOne(e.id,{rank:e.rank});i.info(`[updateRanks] Updated ranks for ${o.length} municipality_scores`)},u=async(e,a)=>{const t=await s(),r=new i.ItemsService("municipalities",{schema:t,accountability:o}),n=await r.readOne(e.key);n&&(await(async(e,{services:a,getSchema:t,logger:i})=>{const r=await t(),s=new a.ItemsService("measure_catalog",{schema:r,accountability:o}),n=new a.ItemsService("municipality_scores",{schema:r,accountability:o}),c=new a.ItemsService("municipalities",{schema:r,accountability:o}),l=(await s.readByQuery({limit:-1})).map(a=>({municipality:e.id,catalog_version:a.id,score_total:0,percentage_rated:0,score_agriculture:0,score_buildings:0,score_management:0,score_energy:0,score_industry:0,score_transport:0})),u=await n.createMany(l);await c.updateOne(e.id,{scores:u}),i.info(`[createEmptyScores] Created ${u.length} municipality_scores for ${e.name}`)})(n,a),await(async(e,{services:a,getSchema:t,logger:i})=>{const r=await t(),s=new a.ItemsService("measures",{schema:r,accountability:o}),n=new a.ItemsService("ratings_measures",{schema:r,accountability:o}),c=await s.readByQuery({limit:-1,filter:{status:{_eq:"published"}}});if(!c?.length)return void i.info(`[createEmptyRatings] No published measures found for new municipality ${e.name}`);const l=c.map(a=>({measure_id:a.id,catalog_version:"object"==typeof a.catalog_version?a.catalog_version.id:a.catalog_version,localteam_id:e.localteam_id,status:"draft",approved:!0,choices:a.choices_rating,rating:null}));await n.createMany(l,{emitEvents:!1}),i.info(`[createEmptyRatings] Created ${l.length} ratings_measures silently for municipality=${e.name}`)})(n,a))},m=async(e,a)=>{n.info("handleMeasureCreatedOrPublished");const t="published"===e.payload.status;if(n.info("[DEBUG] Measure is being published in this change "+t),!t)return;const r=Array.isArray(e.keys)?e.keys[0]:e.key;n.info(`Measureid ${r}`);let u=e.payload.catalog_version,m=e.payload.choices_rating;if(n.info(`Catalog version from payload: ${u} | Rating choices from payload: ${m}`),!u||!m){n.info("Fetching measure as catalogVersion/ratingChoices are not in the update payload. This is normal for updates.");const e=await s(),a=new i.ItemsService("measures",{schema:e,accountability:o}),t=await a.readOne(r);if(!t||!t.catalog_version)return void n.error(`Unable to fetch newly created measure: ${r}`);u="object"==typeof t.catalog_version?t.catalog_version.id:t.catalog_version,m=t.choices_rating}n.info("Creating empty ratings for measure "+r+" and catalog_version "+u),await(async(e,a,t,{services:i,getSchema:r,logger:s})=>{s.info(`Creating empty ratings_measures for measure ${e}`);const n=await r(),c=new i.ItemsService("municipalities",{schema:n,accountability:o}),l=new i.ItemsService("ratings_measures",{schema:n,accountability:o}),u=await c.readByQuery({limit:-1});if(!u?.length)return;const m=u.map(i=>({measure_id:e,catalog_version:a,localteam_id:i.localteam_id,status:"draft",approved:!0,choices:t,rating:null}));await l.createMany(m,{emitEvents:!1}),s.info(`[createEmptyRatingsForNewMeasure] Created ${m.length} ratings for measure=${e} and catalogVersion=${a}`)})(r,u,m,a),await c({catalogVersionId:u},a),await l({catalogVersionId:u},a)},d=async(e,a)=>{const t=await s(),r=new i.ItemsService("ratings_measures",{schema:t,accountability:o}),n=e.key??e.keys[0],u=await r.readOne(n,{fields:["localteam_id.municipality_id","measure_id.catalog_version"]}),m=u.localteam_id?.municipality_id,d="object"==typeof u.measure_id.catalog_version?u.measure_id.catalog_version.id:u.measure_id.catalog_version;m&&d&&(await c({municipalityIds:[m],catalogVersionId:d},a),await l({catalogVersionId:d},a))},g=(e,a)=>async(t,o)=>{try{t&&t.collection||n.warn(`[HOOK:${e}] meta missing or malformed: ${JSON.stringify(t)}`),await a(t,{services:i,getSchema:s,database:r,logger:n})}catch(a){throw n.error(`[HOOK:${e}] Caught error: ${a?.message}`),n.error(a?.stack??a),a}};(async()=>{try{await(async({services:e,getSchema:a,logger:t})=>{const i=await a(),r=new e.ItemsService("municipalities",{schema:i,accountability:o}),s=new e.ItemsService("measure_catalog",{schema:i,accountability:o}),n=new e.ItemsService("municipality_scores",{schema:i,accountability:o});t.info("[syncAllMunicipalityScores] Checking if municipality_scores is empty...");const u=await n.readByQuery({limit:1,fields:["id"]}),m=await s.readByQuery({limit:-1});if(u&&0!=u.length)t.info("[syncAllMunicipalityScores] municipality_scores already exist - only calculating scores and not creating any new ones.");else{t.info("[syncAllMunicipalityScores] municipality_scores is empty - creating new blank ratings");const e=await r.readByQuery({limit:-1});if(!e?.length||!m?.length)return void t.warn("[syncAllMunicipalityScores] No municipalities or catalog versions found.");const a=[];for(const t of e)for(const e of m)a.push({municipality:t.id,catalog_version:e.id,score_total:0,percentage_rated:0,score_agriculture:0,score_buildings:0,score_management:0,score_energy:0,score_industry:0,score_transport:0});if(!a.length)return void t.info("[syncAllMunicipalityScores] No entries to create (unexpected).");t.info(`[syncAllMunicipalityScores] Creating ${a.length} initial municipality_scores...`),await n.createMany(a)}for(const i of m)t.info(`[syncAllMunicipalityScores] Calculating scores for catalog version ${i.id}...`),await c({catalogVersionId:i.id},{services:e,getSchema:a,logger:t}),t.info(`[syncAllMunicipalityScores] Updating ranks for catalog version ${i.id}...`),await l({catalogVersionId:i.id},{services:e,getSchema:a,logger:t});t.info("[syncAllMunicipalityScores] Initial sync completed successfully.")})({services:i,getSchema:s,logger:n})}catch(e){n.error(`[syncAllMunicipalityScores] Failed during startup: ${e.message}`),n.error(e.stack)}})(),a("items.create",g("items.create",async(e,a)=>{switch(e.collection){case"municipalities":return await u(e,a);case"measures":return await m(e,a);case"ratings_measures":return await d(e,a);default:return}})),a("items.update",g("items.update",async(e,a)=>{switch(e.collection){case"measures":return await m(e,a);case"ratings_measures":return await d(e,a);default:return}}))};

