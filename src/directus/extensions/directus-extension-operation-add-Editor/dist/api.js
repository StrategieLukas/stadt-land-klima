var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,r=e||t||Function("return this")(),n=r.Symbol,o=Object.prototype,a=o.hasOwnProperty,c=o.toString,i=n?n.toStringTag:void 0;var l=Object.prototype.toString;var u=n?n.toStringTag:void 0;function s(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":u&&u in Object(e)?function(e){var t=a.call(e,i),r=e[i];try{e[i]=void 0;var n=!0}catch(e){}var o=c.call(e);return n&&(t?e[i]=r:delete e[i]),o}(e):function(e){return l.call(e)}(e)}function f(e){return null!=e&&"object"==typeof e}var b=Array.isArray;function p(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function y(e){if(!p(e))return!1;var t=s(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}var j,d=r["__core-js_shared__"],m=(j=/[^.]+$/.exec(d&&d.keys&&d.keys.IE_PROTO||""))?"Symbol(src)_1."+j:"";var v=Function.prototype.toString;function g(e){if(null!=e){try{return v.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var w=/^\[object .+?Constructor\]$/,O=Function.prototype,h=Object.prototype,S=O.toString,A=h.hasOwnProperty,_=RegExp("^"+S.call(A).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function x(e){return!(!p(e)||(t=e,m&&m in t))&&(y(e)?_:w).test(g(e));var t}function P(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return x(r)?r:void 0}var E=P(r,"WeakMap");function F(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}var U=Object.prototype;function M(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||U)}function T(e){return f(e)&&"[object Arguments]"==s(e)}var k=Object.prototype,B=k.hasOwnProperty,I=k.propertyIsEnumerable,$=T(function(){return arguments}())?T:function(e){return f(e)&&B.call(e,"callee")&&!I.call(e,"callee")};var R="object"==typeof exports&&exports&&!exports.nodeType&&exports,D=R&&"object"==typeof module&&module&&!module.nodeType&&module,q=D&&D.exports===R?r.Buffer:void 0,N=(q?q.isBuffer:void 0)||function(){return!1},V={};V["[object Float32Array]"]=V["[object Float64Array]"]=V["[object Int8Array]"]=V["[object Int16Array]"]=V["[object Int32Array]"]=V["[object Uint8Array]"]=V["[object Uint8ClampedArray]"]=V["[object Uint16Array]"]=V["[object Uint32Array]"]=!0,V["[object Arguments]"]=V["[object Array]"]=V["[object ArrayBuffer]"]=V["[object Boolean]"]=V["[object DataView]"]=V["[object Date]"]=V["[object Error]"]=V["[object Function]"]=V["[object Map]"]=V["[object Number]"]=V["[object Object]"]=V["[object RegExp]"]=V["[object Set]"]=V["[object String]"]=V["[object WeakMap]"]=!1;var W,z="object"==typeof exports&&exports&&!exports.nodeType&&exports,C=z&&"object"==typeof module&&module&&!module.nodeType&&module,L=C&&C.exports===z&&e.process,G=function(){try{var e=C&&C.require&&C.require("util").types;return e||L&&L.binding&&L.binding("util")}catch(e){}}(),K=G&&G.isTypedArray,Q=K?(W=K,function(e){return W(e)}):function(e){return f(e)&&F(e.length)&&!!V[s(e)]};var H=function(e,t){return function(r){return e(t(r))}}(Object.keys,Object),J=Object.prototype.hasOwnProperty;var X=P(r,"Map"),Y=P(r,"DataView"),Z=P(r,"Promise"),ee=P(r,"Set"),te="[object Map]",re="[object Promise]",ne="[object Set]",oe="[object WeakMap]",ae="[object DataView]",ce=g(Y),ie=g(X),le=g(Z),ue=g(ee),se=g(E),fe=s;(Y&&fe(new Y(new ArrayBuffer(1)))!=ae||X&&fe(new X)!=te||Z&&fe(Z.resolve())!=re||ee&&fe(new ee)!=ne||E&&fe(new E)!=oe)&&(fe=function(e){var t=s(e),r="[object Object]"==t?e.constructor:void 0,n=r?g(r):"";if(n)switch(n){case ce:return ae;case ie:return te;case le:return re;case ue:return ne;case se:return oe}return t});var be=fe,pe=Object.prototype.hasOwnProperty;function ye(e){if(null==e)return!0;if(function(e){return null!=e&&F(e.length)&&!y(e)}(e)&&(b(e)||"string"==typeof e||"function"==typeof e.splice||N(e)||Q(e)||$(e)))return!e.length;var t=be(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(M(e))return!function(e){if(!M(e))return H(e);var t=[];for(var r in Object(e))J.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e).length;for(var r in e)if(pe.call(e,r))return!1;return!0}var je={id:"operation-add-editor",handler:async({email:e,localteam_id:t},{logger:r,accountability:n,services:o,getSchema:a})=>{n.admin=!0,r.info(e,"email"),r.info(t,"localteam_id");const{UsersService:c,RolesService:i,MailService:l,ItemsService:u}=o,s=await a(),f=new c({schema:s,accountability:n}),b=new i({schema:s,accountability:n}),p=new u("localteams",{schema:s,accountability:n}),y=new l({schema:s,accountability:n});f.validateEmail(e);let j=f.inviteUrl(e);const d=await f.getUserByEmail(e),m=await b.readByQuery({fields:["*"],filter:{name:{_eq:"EditorLocalteam"}}});r.info(m[0].id);const v=await f.readOne(n.user,{fields:["id","first_name","last_name","email"]}),g=await p.readOne(t,{fields:["id","municipality_name"]}),w=v.first_name+" "+v.last_name;if(r.info(v),r.info(g),ye(d)){await f.createOne({email:e,role:m[0].id,status:"invited",localteams:[{localteam_id:t}]});const r="Sie wurden zu Stadt.Land.Klima eingeladen als Redakteur*in!";await y.send({to:e,subject:r,template:{name:"email-template-invite",data:{url:j,email:e,fullName:w,municipality_name:g.municipality_name}}})}else if(d.role!==m[0].id)throw new Error("User has different role")}};export{je as default};
