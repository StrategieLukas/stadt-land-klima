import t from"path";import{writeFileSync as e,unlinkSync as r}from"fs";import n from"stream";function a(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var i,o,s,u,c,f,l,h;function p(){if(o)return i;function t(t){if(null===t)return"null";if(t&&(1===t.nodeType||9===t.nodeType))return"element";var e=Object.prototype.toString.call(t).match(/\[object (.*?)\]/)[1].toLowerCase();if("number"===e){if(isNaN(t))return"nan";if(!isFinite(t))return"infinity"}return e}function e(e,n,a,i,o){return"undefined"===t(e)?r("",n,a,i):"null"===t(e)?r("null",n,a,i):Array.isArray(e)?s(e,n,a,i,o):"object"==typeof e?u(e,n,a,i,o):r(String(e),n,a,i)}function r(t,e,r,n,a){return e&&e[r]||(e[r]=[]),n<e[r].length&&(n=e[r].length),e[r][n]=t,e}function n(e){return e.every(function(e){return!t(e).match(/array|object/)})}function a(t){return t?String(t).trim().replace(/^["|'](.*)["|']$/,"$1"):""}function s(t,a,i,o,s){if(n(t))return r(t.join(";"),a,i+s.arrayDenote,o);t.forEach(function(t,r){return e(t,a,i+s.arrayDenote,r,s)})}function u(t,r,n,a,i){Object.keys(t).forEach(function(o){return e(t[o],r,n+i.objectDenote+o,a,i)})}function c(t,e,r){if(r&&-1!==t.indexOf(r))return f(t,e,r);var n=[];return t.split(e).forEach(function(t){var e=t.trim();n.push(e)}),n}function f(t,e,r){e=e||",",r=r||'"';var n=new RegExp("(?!\\s*$)\\s*(?:"+r+"([^"+r+"\\\\]*(?:\\\\[\\S\\s][^"+r+"\\\\]*)*)"+r+"|([^"+e+r+"\\s\\\\]*(?:\\s+[^"+e+r+"\\s\\\\]+)*))\\s*(?:"+e+"|$)","g"),a=[];return t.replace(n,function(t,e,r){return void 0!==e?a.push(e.replace(/\\'/g,"'")):void 0!==r&&a.push(r),""}),/,\s*$/.test(t)&&a.push(""),a}return o=1,i={getQuoteChar:function(t){if("string"==typeof t)return t;if(!0===t)return'"';return null},dataType:t,toCsv:e,putData:r,allObjsOrArray:n,getHeaders:function(t,e,r){var n=/([^\[\]\.]+)$/,a=/\[\]\.?([^\[\]]+)$/;switch(t){case"none":return null;case"full":return Object.keys(e);case"key":return Object.keys(e).map(function(t){var e=t.match(n);return e&&2===e.length?e[1]:t});case"relative":return Object.keys(e).map(function(t){var e=t.match(a);return e&&2===e.length?e[1]:t})}},getLengthyItem:function(t){var e=0;return Object.keys(t).forEach(function(r){Array.isArray(t[r])&&t[r].length>e&&(e=t[r].length)}),e},addDataInSchema:function t(e,r,n,i,o){var s,u,f=e.match(/\[*[\d]\]\.(\w+)|\.|\[\]|\[(.)\]|-|\+/gi);if(f){var l=f[0];if(-1!==f.indexOf("-"))return!0;if(-1!==f.indexOf(".")){var h=e.split(".");n[u=h.shift()]=n[u]||{},t(h.join("."),r,n[u],i,o)}else if(-1!==f.indexOf("[]"))n[s=e.replace(/\[\]/gi,"")]||(n[s]=[]),n[s].push(r);else if(/\[*[\d]\]\.(\w+)/.test(l)){s=e.split("[").shift();var p=parseInt(l.match(/\[(.)\]/).pop(),10);u=e.split(".").pop(),n[s]=n[s]||[],n[s][p]=n[s][p]||{},n[s][p][u]=r}else if(/\[(.)\]/.test(l)){i=l.match(/\[(.)\]/).pop();n[s=e.replace(/\[(.)\]/gi,"")]=c(r,i,o)}else-1!==f.indexOf("+")&&(n[s=e.replace(/\+/gi,"")]=Number(r))}else n[e]=a(r);return n},removeQuote:a,arrayToCsv:s,objectToCsv:u,convertArray:c,csvToArray:f},i}function d(){if(u)return s;u=1;var t=p();return s={toObject:function(e,r){var n=(r=r||{}).delimiter||",",a=t.getQuoteChar(r.quote),i=e,o=null;if("string"!=typeof i)throw new Error("Invalid input, input data should be a string");i=i.split(/[\n\r]+/gi),"string"==typeof r.headers?(o=r.headers.split(/[\n\r]+/gi),o=a?t.convertArray(o.shift(),n,a):o.shift().split(n)):o=a?t.convertArray(i.shift(),n,a):i.shift().split(n);var s=[];return i.forEach(function(e){if(e){e=a?t.convertArray(e,n,a):e.split(n);var r={};o.forEach(function(n,a){r[n]=t.removeQuote(e[a])}),s.push(r)}}),s},toArray:function(e,r){var n=(r=r||{}).delimiter||",",a=t.getQuoteChar(r.quote),i=e;if("string"!=typeof i)throw new Error("Invalid input, input data should be a string");i=i.split(/[\n\r]+/gi);var o=[];return i.forEach(function(e){e&&(e=(e=a?t.convertArray(e,n,a):e.split(n)).map(function(e){return t.removeQuote(e)}),o.push(e))}),o},toColumnArray:function(e,r){var n=(r=r||{}).delimiter||",",a=t.getQuoteChar(r.quote),i=e,o=null;if("string"!=typeof i)throw new Error("Invalid input, input data should be a string");i=i.split(/[\n\r]+/gi),"string"==typeof r.headers?(o=r.headers.split(/[\n\r]+/gi),o=a?t.convertArray(o.shift(),n,a):o.shift().split(n)):o=a?t.convertArray(i.shift(),n,a):i.shift().split(n);var s={};return o.forEach(function(t){s[t]=[]}),i.forEach(function(e){e&&(e=a?t.convertArray(e,n,a):e.split(n)).forEach(function(e,r){s[o[r]].push(t.removeQuote(e))})}),s},toSchemaObject:function(e,r){var n=(r=r||{}).delimiter||",",a=t.getQuoteChar(r.quote),i=e,o=null;if("string"!=typeof i)throw new Error("Invalid input, input should be a string");i=i.split(/[\n\r]+/gi),"string"==typeof r.headers?(o=r.headers.split(/[\n\r]+/gi),o=a?t.convertArray(o.shift(),n,a):o.shift().split(n)):o=a?t.convertArray(i.shift(),n,a):i.shift().split(n);var s=[];return i.forEach(function(e){if(e){e=a?t.convertArray(e,n,a):e.split(n);var r={};e.forEach(function(e,i){t.addDataInSchema(o[i],e,r,n,a)}),s.push(r)}}),s},toCSV:function(e,r){(r=r||{}).delimiter=r.delimiter||",",r.wrap=r.wrap||"",r.arrayDenote=r.arrayDenote&&String(r.arrayDenote).trim()?r.arrayDenote:"[]",r.objectDenote=r.objectDenote&&String(r.objectDenote).trim()?r.objectDenote:".",r.detailedOutput="boolean"!=typeof r.detailedOutput||r.detailedOutput,r.headers=String(r.headers).toLowerCase();var n={},a="";r.headers.match(/none|full|relative|key/)?r.headers=r.headers.match(/none|full|relative|key/)[0]:r.headers="full";!0===r.wrap&&(r.wrap='"');"string"==typeof e&&(e=JSON.parse(e));t.toCsv(e,n,"",0,r);var i=t.getHeaders(r.headers,n,r);i&&(r.wrap&&(i=i.map(function(t){return r.wrap+t+r.wrap})),a=i.join(r.delimiter));var o=t.getLengthyItem(n),s=Object.keys(n),u=[],c=/\n|\r/g;r.wrap||(c=new RegExp("\n|\r|"+r.delimiter,"g"));for(var f=0;f<o;f++){u=[];for(var l=0;l<s.length;l++)n[s[l]][f]?(n[s[l]][f]=n[s[l]][f].replace(c,"\t"),r.wrap&&(n[s[l]][f]=r.wrap+n[s[l]][f]+r.wrap),u[u.length]=n[s[l]][f]):u[u.length]="";a+="\n"+u.join(r.delimiter)}return a}},s}function m(){if(f)return c;f=1;var t=d();function e(t){return t.split(/[\n\r]/gi)}function r(t){return new n.Transform({readableObjectMode:!0,writableObjectMode:!0,transform:t})}function a(r,n,a,i){var o=e(r.toString());if(!i._head){var s=o.shift();i._head=s,i._opts.headers=s}this.push(t.toColumnArray(o.join("\n"),i._opts)),a()}function i(r,n,a,i){var o=e(r.toString());if(!i._head){var s=o.shift();i._head=s,i._opts.headers=s}this.push(t.toObject(o.join("\n"),i._opts)),a()}function o(r,n,a,i){var o=e(r.toString());if(!i._head){var s=o.shift();i._head=s,i._opts.headers=s}this.push(t.toSchemaObject(o.join("\n"),i._opts)),a()}function s(r,n,a,i){var o=e(r.toString());this.push(t.toArray(o.join("\n"),i._opts)),a()}return c={toColumnArray:function(t){t=t||{};var e=r(function(t,r,n){a.call(this,t,r,n,e)});return e._head=t.headers?t.headers:null,e._opts=t,e},toObject:function(t){t=t||{};var e=r(function(t,r,n){i.call(this,t,r,n,e)});return e._head=t.headers?t.headers:null,e._opts=t,e},toSchemaObject:function(t){t=t||{};var e=r(function(t,r,n){o.call(this,t,r,n,e)});return e._head=t.headers?t.headers:null,e._opts=t,e},toArray:function(t){t=t||{};var e=r(function(t,r,n){s.call(this,t,r,n,e)});return e._opts=t,e},transform:r,stringify:function(t){return r(function(e,r,n){this.push(JSON.stringify(e,null,t)),n()})}}}var v=function(){if(h)return l;h=1;var t=d(),e=m();return t.stream=e,l=t}(),g=a(v),y=({schedule:n},{accountability:a,services:i,database:o,getSchema:s})=>{const{MailService:u,ItemsService:c}=i;n("0 0 * * 0",async()=>{const n=await s(),i=new c("ratings_measures",{database:o,schema:n}),f=await i.readByQuery({limit:-1,fields:["applicable","approved","choices","current_progress","date_created","date_updated","measure_published","rating","source","status","id","localteam_id.municipality_id.name","measure_id.catalog_version.name","measure_id.catalog_version.id","measure_id.date_updated","measure_id.measure_id","measure_id.must_be_rated_again","measure_id.name"]}),l=t.join(process.cwd(),"/extensions/directus-extension-hook-measure-rating-reports"),h=new Date,p=`rating_measures-${h.getDate()+"-"+(h.getMonth()+1)+"-"+h.getFullYear()}.csv`,d=t.join(l,p);const m=g.toCSV(f,{delimiter:",",wrap:!0});e(d,m,{flag:"w"});const v=new u({schema:n,accountability:a});await v.send({to:"massnahmen@stadt-land-klima.de",subject:"Stadt.Land.Klima Wochenbericht",text:"Please find attached the CSV file.",attachments:[{filename:p,path:d}]}),r(d)})};export{y as default};
