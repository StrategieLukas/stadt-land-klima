import e from"path";import{writeFileSync as a,unlinkSync as t}from"fs";var s=({schedule:s},{accountability:n,services:i,database:o,getSchema:c})=>{const{MailService:r,ItemsService:m}=i;s("*/1 * * * *",async()=>{console.log("1 minute has passed");const s=await c(),i=new r({schema:s,accountability:n}),l=new m("ratings_measures",{database:o,schema:s}),d=await l.readByQuery({limit:-1}),u=e.join(process.cwd(),"/extensions/directus-extension-hook-measure-rating-reports"),h=`rating_measures-${Date.now()}.csv`,f=e.join(u,h),p=function(e){const a=JSON.parse(e),t=Object.keys(a[0]),s=a.map(e=>t.map(a=>`"${null!==e[a]?e[a]:""}"`).join(","));return`${t.join(",")}\n${s.join("\n")}`}(JSON.stringify(d));a(f,p,{flag:"w"});await i.send({to:"TODO: info@stadt-land-klima.de",subject:"Stadt.Land.Klima Wochenbericht",text:"Please find attached the CSV file.",attachments:[{filename:"rating_measures.csv",path:f}]}),t(f)})};export{s as default};
