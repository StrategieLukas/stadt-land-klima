import t from"path";import{execFile as e}from"child_process";var s={id:"pdf-service",handler:async(s,{services:n,getSchema:o})=>{const{ItemsService:i}=n;s.get("/",(t,e)=>e.send("Hello, World!")),s.post("/test",async(s,n)=>{let r=n.accountability;const a=await o();console.log(s);const c=s.body.municipality;if(!c)return n.status(400).send("Missing 'municipality' parameter");console.log(c),console.log(r);try{const t=new i("municipalities",{schema:a,accountability:r}),e=await t.readOne(c);if(null==e)return n.status(403),n.send("You don't have permission to access this.");console.log(e)}catch(t){console.log("eror",t)}const l={municipality:c,state:"Sachsen",ranking:43,circular_barplot_values:{energy:20,transport:40,ann:60,iec:80,bh:15,cpma:100},progress:22};try{const s=t.join(process.cwd(),"/extensions/directus-extension-pdf-service/dist/typst"),o=t.join(s,"municpality_overview.typ"),i=["compile","--input",`data=${JSON.stringify(l)}`,"--font-path",`${s}/fonts`,o,"-"];e("typst",i,{maxBuffer:52428800,encoding:"buffer"},(t,e,s)=>{if(t)return void console.error("error:",t);s&&s.length&&console.error("typst stderr:",s.toString());const o=Buffer.from(e);n.setHeader("Content-Type","application/pdf"),n.setHeader("Content-Disposition",'inline; filename="output.pdf"'),n.status(200).send(o)})}catch(t){n.status(500).send("PDF generation failed")}})}};export{s as default};
