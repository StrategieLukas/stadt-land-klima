import e from"path";import{execFile as t}from"child_process";import{writeFileSync as i,unlinkSync as n}from"fs";var s={id:"pdf-service",handler:async(s,{services:r,getSchema:a})=>{const{ItemsService:o}=r;s.post("/municipality/:slug/:version",async(s,r)=>{const c=s.accountability,u=await a(),l=s.params.slug,p=s.params.version;if(!l)return r.status(400).send("Missing municipality slug in path");try{const s=new o("municipality_scores",{schema:u,accountability:c}),a=await s.readByQuery({fields:["date_updated","score_total","score_buildings","score_energy","score_transport","score_industry","score_management","score_agriculture","percentage_rated","rank","municipality.id","municipality.name","municipality.slug","municipality.localteam_id","municipality.municipality_type","municipality.state","municipality.overall_status_comment"],filter:{catalog_version:{name:{_eq:p}},municipality:{slug:{_eq:l}}},limit:1});if(!a||!a[0])return r.status(404).send(`No scores found for municipality "${l}" or access denied`);const m=a[0],d=new o("measures",{schema:u,accountability:c}),y=await d.readByQuery({filter:{catalog_version:{name:{_eq:p}}}});if(!y)return r.status(404).send("Measures not found or access denied");const f=new o("ratings_measures",{schema:u,accountability:c}),g=await f.readByQuery({filter:{localteam_id:{_eq:m.municipality.localteam_id}}});if(!g)return r.status(404).send("Rating measures not found or access denied");const _=function(e,t){if(!Array.isArray(e)||!Array.isArray(t))return{};const i=new Map(t.map(e=>[e.id,e])),n={};for(const t of e){const e=i.get(t.measure_id);if(e){const{sector:i}=e;t.measure=e,n[i]=n[i]||[],n[i].push(t)}}return n}(g,y),h=e.join(process.cwd(),"/extensions/directus-extension-endpoint-pdf-service/typst"),w=e.join(h,"municipality_summary.typ"),v=Date.now(),x=`municipalityScore_${v}.json`,j=`measures_${v}.json`,S=e.join(h,x),b=e.join(h,j);i(S,JSON.stringify(m)),i(b,JSON.stringify(_));t("typst",["compile","--input",`municipalityScore=${x}`,"--input",`measures=${j}`,"--font-path",`${h}/fonts`,w,"-"],{maxBuffer:52428800,encoding:"buffer"},(e,t,i)=>{try{n(S),n(b)}catch(e){console.error("Error cleaning up temporary files:",e)}if(e)return console.error("Typst error:",e),r.status(500).send("PDF generation failed");i&&i.length&&console.warn("Typst warnings:",i.toString()),r.setHeader("Content-Type","application/pdf"),r.setHeader("Content-Disposition",'inline; filename="output.pdf"'),r.status(200).send(t)})}catch(e){return console.error("Error fetching municipality:",e),r.status(500).send("Server error")}}),s.post("/elections/:slug",async(s,r)=>{s.accountability,await a();const o=s.body.measure_text;s.params.slug,console.log("elections pdf endpoint requested");const c=e.join(process.cwd(),"/extensions/directus-extension-endpoint-pdf-service/typst"),u=e.join(c,"local_election_checklist_guide.typ"),l=`elections_measure_text_${Date.now()}.json`,p=e.join(c,l);i(p,JSON.stringify({measure_text:o}));t("typst",["compile","--input",`measureText=${l}`,"--font-path",`${c}/fonts`,u,"-"],{maxBuffer:52428800,encoding:"buffer"},(e,t,i)=>{try{n(p)}catch(e){console.error("Error cleaning up temporary files:",e)}if(e)return console.error("Typst error:",e),r.status(500).send("PDF generation failed");i&&i.length&&console.warn("Typst warnings:",i.toString()),r.setHeader("Content-Type","application/pdf"),r.setHeader("Content-Disposition",'inline; filename="output.pdf"'),r.status(200).send(t)})})}};export{s as default};
