import e from"path";import{execFile as t}from"child_process";import{writeFileSync as i,unlinkSync as s}from"fs";var n={id:"pdf-service",handler:async(n,{services:r,getSchema:a})=>{const{ItemsService:o}=r;n.get("/",(e,t)=>t.send("Hello, World!")),n.post("/municipality/:slug/:version",async(n,r)=>{const c=n.accountability,u=await a(),l=n.params.slug,p=n.params.version;if(!l)return r.status(400).send("Missing municipality slug in path");try{const n=new o("municipality_scores",{schema:u,accountability:c}),a=await n.readByQuery({fields:["date_updated","score_total","score_buildings","score_energy","score_transport","score_industry","score_management","score_agriculture","percentage_rated","rank","municipality.id","municipality.name","municipality.slug","municipality.localteam_id","municipality.population","municipality.state","municipality.overall_status_comment"],filter:{catalog_version:{name:{_eq:p}},municipality:{slug:{_eq:l}}},limit:1});if(!a||!a[0])return r.status(404).send(`No scores found for municipality "${l}" or access denied`);const m=a[0];console.log(m);const d=new o("measures",{schema:u,accountability:c}),y=await d.readByQuery({});if(!y)return r.status(404).send("Measures not found or access denied");const f=new o("ratings_measures",{schema:u,accountability:c}),g=await f.readByQuery({filter:{localteam_id:{_eq:m.municipality.localteam_id}}});if(!g)return r.status(404).send("Rating measures not found or access denied");const _=function(e,t){if(!Array.isArray(e)||!Array.isArray(t))return{};const i=new Map(t.map(e=>[e.id,e])),s={};for(const t of e){const e=i.get(t.measure_id);if(e){const{sector:i}=e;t.measure=e,s[i]=s[i]||[],s[i].push(t)}}return s}(g,y),h=e.join(process.cwd(),"/extensions/directus-extension-endpoint-pdf-service/typst"),w=e.join(h,"municipality_summary.typ"),v=Date.now(),S=`municipalityScore_${v}.json`,b=`measures_${v}.json`,j=e.join(h,S),$=e.join(h,b);i(j,JSON.stringify(m)),i($,JSON.stringify(_));t("typst",["compile","--input",`municipalityScore=${S}`,"--input",`measures=${b}`,"--font-path",`${h}/fonts`,w,"-"],{maxBuffer:52428800,encoding:"buffer"},(e,t,i)=>{try{s(j),s($)}catch(e){console.error("Error cleaning up temporary files:",e)}if(e)return console.error("Typst error:",e),r.status(500).send("PDF generation failed");i&&i.length&&console.warn("Typst warnings:",i.toString()),r.setHeader("Content-Type","application/pdf"),r.setHeader("Content-Disposition",'inline; filename="output.pdf"'),r.status(200).send(t)})}catch(e){return console.error("Error fetching municipality:",e),r.status(500).send("Server error")}})}};export{n as default};
