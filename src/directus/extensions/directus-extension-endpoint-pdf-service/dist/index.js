import t from"path";import{execFile as e}from"child_process";var n={id:"pdf-service",handler:async(n,{services:i,getSchema:s})=>{const{ItemsService:r}=i;n.get("/",(t,e)=>e.send("Hello, World!")),n.post("/municipality/:slug",async(n,i)=>{const a=n.accountability,o=await s(),c=n.params.slug;if(!c)return i.status(400).send("Missing municipality slug in path");try{const n=new r("municipalities",{schema:o,accountability:a}),s=await n.readByQuery({filter:{slug:{_eq:c}},limit:1});if(!s||!s[0])return i.status(404).send(`Municipality "${c}" not found`);const p=s[0];console.log(p);const l={municipality:c,state:p.state||"Unknown",ranking:43,circular_barplot_values:{energy:20,transport:40,ann:60,iec:80,bh:15,cpma:100},progress:22},u=t.join(process.cwd(),"/extensions/directus-extension-pdf-service/dist/typst"),d=t.join(u,"municpality_overview.typ"),f=["compile","--input",`data=${JSON.stringify(l)}`,"--font-path",`${u}/fonts`,d,"-"];e("typst",f,{maxBuffer:52428800,encoding:"buffer"},(t,e,n)=>{if(t)return console.error("Typst error:",t),i.status(500).send("PDF generation failed");n&&n.length&&console.warn("Typst warnings:",n.toString()),i.setHeader("Content-Type","application/pdf"),i.setHeader("Content-Disposition",'inline; filename="output.pdf"'),i.status(200).send(e)})}catch(t){return console.error("Error fetching municipality:",t),i.status(500).send("Server error")}})}};export{n as default};
