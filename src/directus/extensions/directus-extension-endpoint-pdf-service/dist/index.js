import e from"path";import{execFile as t}from"child_process";import{writeFileSync as r,unlinkSync as i}from"fs";async function n(e,t,r,i){const n=e.accountability,s=e.params.slug,a=e.params.version;if(!s)return t.status(400).send("Missing municipality slug in path");const o=new i("municipality_scores",{schema:r,accountability:n}),c=await o.readByQuery({fields:["date_updated","score_total","score_buildings","score_energy","score_transport","score_industry","score_management","score_agriculture","percentage_rated","rank","municipality.id","municipality.name","municipality.slug","municipality.localteam_id","municipality.municipality_type","municipality.state","municipality.overall_status_comment"],filter:{catalog_version:{name:{_eq:a}},municipality:{slug:{_eq:s}}},limit:1});if(!c||!c[0])return t.status(404).send(`No scores found for municipality "${s}" or access denied`);const u=c[0],l=new i("measures",{schema:r,accountability:n}),p=await l.readByQuery({filter:{catalog_version:{name:{_eq:a}}}});if(!p)return t.status(404).send("Measures not found or access denied");const m=new i("ratings_measures",{schema:r,accountability:n}),y=await m.readByQuery({filter:{localteam_id:{_eq:u.municipality.localteam_id}}});if(!y)return t.status(404).send("Rating measures not found or access denied");return[u,function(e,t){if(!Array.isArray(e)||!Array.isArray(t))return{};const r=new Map(t.map(e=>[e.id,e])),i={};for(const t of e){const e=r.get(t.measure_id);if(e){const{sector:r}=e;t.measure=e,i[r]=i[r]||[],i[r].push(t)}}return i}(y,p)]}var s={id:"pdf-service",handler:async(s,{services:a,getSchema:o})=>{const c=e.join(process.cwd(),"/extensions/directus-extension-endpoint-pdf-service/typst"),{ItemsService:u}=a;s.post("/municipality/:slug/:version",async(s,a)=>{const l=await o();let p,m;try{[p,m]=await n(s,a,l,u)}catch(e){return console.error("Error fetching municipality:",e),a.status(500).send("Server error: Error fetching municipality")}const y=e.join(c,"municipality_summary.typ"),d=Date.now(),f=`municipalityScore_${d}.json`,g=`measures_${d}.json`,_=e.join(c,f),h=e.join(c,g);try{r(_,JSON.stringify(p)),r(h,JSON.stringify(m))}catch(e){return console.error("Error saving temporary Score and measure files"),a.status(500).send("Server error: Error saving temporary Score and measure files")}t("typst",["compile","--input",`municipalityScore=${f}`,"--input",`measures=${g}`,"--font-path",`${c}/fonts`,y,"-"],{maxBuffer:52428800,encoding:"buffer"},(e,t,r)=>{try{i(_),i(h)}catch(e){console.error("Error cleaning up temporary files:",e)}if(e)return console.error("Typst error:",e),a.status(500).send("PDF generation failed");r&&r.length&&console.warn("Typst warnings:",r.toString()),a.setHeader("Content-Type","application/pdf"),a.setHeader("Content-Disposition",'inline; filename="output.pdf"'),a.status(200).send(t)})}),s.post("/elections/:slug/:version",async(s,a)=>{const l=await o(),p=s.params.slug,m=s.body.measure_text;let y,d;console.log("elections pdf endpoint requested for: ",p);try{[y,d]=await n(s,a,l,u)}catch(e){return console.error("Error fetching municipality:",e),a.status(500).send("Server error: Error fetching municipality")}const f=e.join(c,"local_election_checklist_guide.typ"),g=Date.now(),_=`elections_measure_text_${g}.json`,h=e.join(c,_),w=`municipalityScore_${g}.json`,S=e.join(c,w),v=`measures_${g}.json`,$=e.join(c,v);r(h,JSON.stringify({measure_text:m})),r(S,JSON.stringify(y)),r($,JSON.stringify(d));t("typst",["compile","--input",`municipality=${p}`,"--input",`electionGuideText=${_}`,"--input",`municipalityScore=${w}`,"--input",`measures=${v}`,"--font-path",`${c}/fonts`,f,"-"],{maxBuffer:52428800,encoding:"buffer"},(e,t,r)=>{try{i(h),i(S),i($)}catch(e){console.error("Error cleaning up temporary files:",e)}if(e)return console.error("Typst error:",e),a.status(500).send("PDF generation failed");r&&r.length&&console.warn("Typst warnings:",r.toString()),a.setHeader("Content-Type","application/pdf"),a.setHeader("Content-Disposition",'inline; filename="output.pdf"'),a.status(200).send(t)})})}};export{s as default};
